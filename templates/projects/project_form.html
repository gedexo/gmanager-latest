{% extends 'app/base.html' %}
{% load static i18n crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}Edit Project{% else %}New Project{% endif %}
{% endblock %}

{% block content %}
<div class="side-app main-container edit_page pb-5">

    <!-- HEADER -->
    <div class="page-header d-flex justify-content-between align-items-end border-bottom mb-4 pb-3">
        <div>
            <h1 class="page-title fs-4 fw-bold mb-0 text-dark">
                {% if form.instance.pk %}Edit Project{% else %}New Project{% endif %}
            </h1>
            <small class="text-muted">Manage your project details, timeline, and tasks</small>
        </div>
        
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="javascript:void(0);" class="text-decoration-none text-muted">Projects</a></li>
                <li class="breadcrumb-item active" aria-current="page">Form</li>
            </ol>
        </nav>
    </div>

    <!-- FORM CONTAINER -->
    <div class="row justify-content-center">
        <div class="col-xl-12 col-lg-12">
            
            <form method="post" autocomplete="off" enctype="multipart/form-data" id="project-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger shadow-sm rounded-3 border-0 mb-4">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}

                {% if task_formset.non_form_errors %}
                    <div class="alert alert-danger shadow-sm rounded-3 border-0 mb-4">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        {{ task_formset.non_form_errors }}
                    </div>
                {% endif %}

                <div class="row g-4">
                    
                    <!-- LEFT COLUMN: MAIN CONTENT -->
                    <div class="col-lg-8">
                        <div class="card custom-card border-0 shadow-sm rounded-3 h-100">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">Core Information</h6>
                                
                                <div class="mb-4">
                                    {{ form.name|as_crispy_field }}
                                </div>
                                <div class="mb-4 compact-description">
                                    {{ form.details|as_crispy_field }}
                                </div>
                                
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: SIDEBAR META -->
                    <div class="col-lg-4">
                        <!-- PROPERTIES CARD -->
                        <div class="card custom-card border-0 shadow-sm rounded-3 mb-4">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">Properties</h6>
                                <div class="mb-3">
                                    {{ form.client|as_crispy_field }}
                                </div>
                                <div class="mb-3">
                                    {{ form.status|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <!-- TIMELINE CARD -->
                        <div class="card custom-card border-0 shadow-sm rounded-3">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">Schedule</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        {{ form.start_date|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.end_date|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-top border-light">
                                    {{ form.delivery_date|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <div class="card custom-card border-0 shadow-sm rounded-3">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">References</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        {{ form.department|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.subdepartment|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.discord_url|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.referred_by|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TASK INLINE FORMSET SECTION -->
                <div class="card custom-card border-0 shadow-sm rounded-3 mt-4">
                    <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                        <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-0">Project Tasks</h6>
                        <button type="button" id="add-task-btn" class="btn btn-sm btn-light border text-primary fw-bold">
                            <i class="fa fa-plus me-1"></i> Add Task
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {{ task_formset.management_form }}
                        
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tasks-table">
                                <thead class="bg-light text-muted fs-11 text-uppercase">
                                    <tr>
                                        <th style="width: 20%;">Task Title</th>
                                        <th style="width: 15%;">Assign To</th>
                                        <th style="width: 12%;">Start Date</th>
                                        <th style="width: 12%;">End Date</th>
                                        <th style="width: 20%;">Description</th>
                                        <th style="width: 15%;">Attachment</th>
                                        <th style="width: 10%;">Status</th>
                                        <th style="width: 5%;" class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="task-form-container">
                                    {% for task_form in task_formset %}
                                        <tr class="task-row {% if task_form.instance.pk and task_form.DELETE.value %}d-none{% endif %}" id="task-row-{{ forloop.counter0 }}">
                                            {% for hidden in task_form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                            
                                            <td class="p-2">
                                                {{ task_form.title }}
                                                {% if task_form.title.errors %}
                                                    <div class="text-danger small">{{ task_form.title.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.assigned_to }}
                                                {% if task_form.assigned_to.errors %}
                                                    <div class="text-danger small">{{ task_form.assigned_to.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                <input type="datetime-local" 
                                                       name="{{ task_form.start_from.html_name }}" 
                                                       value="{% if task_form.start_from.value %}{{ task_form.start_from.value|date:'Y-m-d\TH:i' }}{% endif %}" 
                                                       class="form-control datetime-input"
                                                       id="{{ task_form.start_from.id_for_label }}">
                                                {% if task_form.start_from.errors %}
                                                    <div class="text-danger small">{{ task_form.start_from.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                <input type="datetime-local" 
                                                       name="{{ task_form.end_before.html_name }}" 
                                                       value="{% if task_form.end_before.value %}{{ task_form.end_before.value|date:'Y-m-d\TH:i' }}{% endif %}" 
                                                       class="form-control datetime-input"
                                                       id="{{ task_form.end_before.id_for_label }}">
                                                {% if task_form.end_before.errors %}
                                                    <div class="text-danger small">{{ task_form.end_before.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.description }}
                                                {% if task_form.description.errors %}
                                                    <div class="text-danger small">{{ task_form.description.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.attachment }}
                                                {% if task_form.attachment.errors %}
                                                    <div class="text-danger small">{{ task_form.attachment.errors.0 }}</div>
                                                {% endif %}
                                                {% if task_form.instance.attachment %}
                                                    <div class="attachment-preview text-muted mt-1">
                                                        <i class="fa fa-paperclip me-1"></i>
                                                        <small>{{ task_form.instance.attachment.name }}</small>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.status }}
                                                {% if task_form.status.errors %}
                                                    <div class="text-danger small">{{ task_form.status.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2 text-center">
                                                {% if task_formset.can_delete %}
                                                    <div class="d-none">{{ task_form.DELETE }}</div>
                                                    <button type="button" class="btn btn-sm btn-icon btn-light text-danger hover-danger remove-form-row">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM ACTIONS -->
                <div class="card custom-card border-0 shadow-sm rounded-3 mt-4">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted fs-13 ps-2">
                                <span class="text-danger">*</span> Required fields
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" onclick="history.back()" class="btn btn-light border text-muted px-4">
                                    {% translate "Cancel" %}
                                </button>
                                <button type="submit" class="btn btn-primary px-5 fw-bold">
                                    {% translate "Save Project" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- EMPTY ROW TEMPLATE -->
<script type="text/template" id="empty-row-template">
    <tr class="task-row">
        {% for hidden in task_formset.empty_form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        <td class="p-2">
            {{ task_formset.empty_form.title }}
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.assigned_to }}
        </td>
        <td class="p-2">
            <input type="datetime-local" 
                   name="{{ task_formset.empty_form.start_from.html_name }}" 
                   value="" 
                   class="form-control datetime-input"
                   id="id_{{ task_formset.empty_form.prefix }}-start_from">
        </td>
        <td class="p-2">
            <input type="datetime-local" 
                   name="{{ task_formset.empty_form.end_before.html_name }}" 
                   value="" 
                   class="form-control datetime-input"
                   id="id_{{ task_formset.empty_form.prefix }}-end_before">
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.description }}
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.attachment }}
            <div class="attachment-preview text-muted mt-1"></div>
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.status }}
        </td>
        <td class="p-2 text-center">
            <div class="d-none">{{ task_formset.empty_form.DELETE }}</div>
            <button type="button" class="btn btn-sm btn-icon btn-light text-danger hover-danger remove-form-row">
                <i class="fa fa-trash"></i>
            </button>
        </td>
    </tr>
</script>

<!-- Modal -->
{% include 'clients/partials/client_form_modal.html' %}

{% endblock content %}

{% block javascript %}
{{ form.media }}
{{ task_formset.media }}

<style>
    /* Fix for flatpickr calendar z-index */
    .flatpickr-calendar {
        z-index: 1055 !important;
    }
    
    /* Ensure inputs in table fit nicely and look consistent */
    .table .form-control, .table .form-select {
        width: 100%;
        min-width: 80px; 
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
        border: 1px solid #dee2e6;
    }
    
    .table textarea {
        height: 36px;
        resize: none;
        transition: height 0.2s;
    }
    
    .table textarea:focus {
        height: 80px;
        {% comment %} position: absolute;
        width: 250px;
        z-index: 10;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); {% endcomment %}
    }

    .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important; }
    .hover-danger:hover { color: #dc3545 !important; background: #fff1f2; }
    
    /* Attachment preview styling */
    .attachment-preview {
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    /* Make file inputs more compact */
    .table input[type="file"] {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Error styling */
    .text-danger small {
        font-size: 0.75rem;
    }
    
    /* Date input styling */
    .datetime-input {
        min-height: 38px;
        font-size: 0.85rem;
    }
    
    /* Status field styling */
    .table select[name$="-status"] {
        min-width: 120px;
    }
</style>

<script>
    $(document).ready(function () {
        // --- 1. FORMSET LOGIC ---
        const formPrefix = 'project_tasks';
        const totalFormsInput = $(`#id_${formPrefix}-TOTAL_FORMS`);
        const container = $('#task-form-container');

        // ADD TASK BUTTON
        $('#add-task-btn').click(function() {
            const formCount = parseInt(totalFormsInput.val());
            
            // Get the template HTML from the script tag
            const templateHtml = $('#empty-row-template').html();
            
            // Replace __prefix__ with the current index
            const newRowHtml = templateHtml.replace(/__prefix__/g, formCount);
            const $newRow = $(newRowHtml);

            // Set a unique ID for the row
            $newRow.attr('id', `task-row-${formCount}`);
            
            // Apply styling to the new inputs
            $newRow.find('input:not([type=checkbox]), select, textarea').addClass('form-control');

            // Append to the TABLE BODY (tbody)
            container.append($newRow);

            // Update TOTAL_FORMS count
            totalFormsInput.val(formCount + 1);

            // Initialize Select2 on the new row
            initializeSelect2ForElement($newRow.find('select'));
            
            // Initialize file input handler for new row
            initializeFileInput($newRow.find('input[type="file"]'));
            
            // Fix status field initialization
            fixStatusField($newRow.find('select[name$="-status"]'));
        });

        // DELETE TASK BUTTON
        container.on('click', '.remove-form-row', function() {
            const row = $(this).closest('tr');
            const deleteInput = row.find('input[name$="-DELETE"]');
            const idInput = row.find('input[name$="-id"]');

            if (idInput.length && idInput.val()) {
                // Existing Database Record: Check DELETE box and hide
                deleteInput.prop('checked', true);
                row.addClass('d-none');
            } else {
                // New Dynamic Row: Remove completely
                row.remove();
                updateFormIndices();
            }
        });

        // Helper: Update indices
        function updateFormIndices() {
            const currentRows = container.find('tr.task-row:not(.d-none)').length;
            totalFormsInput.val(currentRows);
        }

        // --- 2. STATUS FIELD FIX ---
        function fixStatusField($statusSelect) {
            // Ensure the status field has proper options and default value
            if ($statusSelect.find('option').length === 0) {
                // Add default status options if missing
                const statusOptions = [
                    {value: 'not_started', text: 'Not Started'},
                    {value: 'in_progress', text: 'In Progress'},
                    {value: 'completed', text: 'Completed'},
                    {value: 'on_hold', text: 'On Hold'}
                ];
                
                statusOptions.forEach(option => {
                    $statusSelect.append(new Option(option.text, option.value));
                });
            }
            
            // Set default value if empty
            if (!$statusSelect.val()) {
                $statusSelect.val('not_started');
            }
        }

        // Initialize status fields for existing rows
        container.find('select[name$="-status"]').each(function() {
            fixStatusField($(this));
        });

        // --- 3. SELECT2 INITIALIZATION ---
        initializeSelect2WithModal('#id_client', '#client-form-modal', "Select Client...");
        handleClientFormSubmit("#id_client", "#client-form-modal");

        // Initialize Select2 for all existing task selects
        container.find('select').each(function() {
            initializeSelect2ForElement($(this));
        });

        function initializeSelect2ForElement($el) {
            $el.select2({
                width: '100%',
                placeholder: 'Select...',
                allowClear: true,
                dropdownParent: $el.closest('.modal').length ? $el.closest('.modal') : $(document.body)
            });
        }

        // --- 4. FILE INPUT HANDLING ---
        function initializeFileInput($fileInput) {
            $fileInput.on('change', function() {
                updateAttachmentPreview($(this));
            });
        }

        function updateAttachmentPreview($input) {
            const $row = $input.closest('tr');
            const $preview = $row.find('.attachment-preview');
            const file = $input[0].files[0];
            
            if (file) {
                $preview.html(`<i class="fa fa-paperclip me-1"></i><small>${file.name}</small>`);
            } else {
                $preview.html('');
            }
        }

        // Initialize file inputs for existing rows
        container.find('input[type="file"]').each(function() {
            initializeFileInput($(this));
        });

        // --- 5. FORM SUBMISSION ENHANCEMENT ---
        $('#project-form').on('submit', function(e) {
            console.log('Form submission started...');
            
            // Validate and prepare form data
            let hasErrors = false;
            
            // Validate main project status
            const projectStatus = $('#id_status').val();
            if (!projectStatus) {
                alert('Please select a project status');
                $('#id_status').focus();
                e.preventDefault();
                return false;
            }
            
            // Validate task formsets
            container.find('.task-row:not(.d-none)').each(function(index) {
                const $row = $(this);
                const title = $row.find('input[name$="-title"]').val();
                const startDate = $row.find('input[name$="-start_from"]').val();
                const endDate = $row.find('input[name$="-end_before"]').val();
                const status = $row.find('select[name$="-status"]').val();
                
                console.log(`Task ${index}:`, {title, startDate, endDate, status});
                
                // Only validate if task has a title
                if (title) {
                    if (!startDate || !endDate) {
                        alert('Please fill all required date fields for task ' + (index + 1));
                        hasErrors = true;
                        return false;
                    }
                    
                    // Validate date order
                    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                        alert('End date must be after start date for task ' + (index + 1));
                        hasErrors = true;
                        return false;
                    }
                    
                    // Ensure status has a value
                    if (!status) {
                        $row.find('select[name$="-status"]').val('not_started');
                    }
                }
            });
            
            if (hasErrors) {
                e.preventDefault();
                return false;
            }
            
            // Update management form count
            const visibleRows = container.find('tr.task-row:not(.d-none)').length;
            totalFormsInput.val(visibleRows);
            
            console.log('Form submission completed');
        });

        // --- 6. MODAL LOGIC ---
        function initializeSelect2WithModal(selectSelector, modalTarget, placeholder) {
            var $select = $(selectSelector);
            $select.select2({ 
                placeholder: placeholder, 
                allowClear: true, 
                width: "100%",
                dropdownParent: $select.closest('.modal').length ? $select.closest('.modal') : $(document.body)
            });
            
            $select.on("select2:open", function () {
                var $dropdown = $(".select2-dropdown");
                if (!$dropdown.find(".select2-add-btn-container").length) {
                    var addButtonHtml = `
                        <div class="select2-add-btn-container" style="padding:8px; border-top:1px solid #eee;">
                            <button type="button" class="btn btn-sm btn-outline-primary w-100 fw-bold border-0" 
                                    data-bs-toggle="modal" data-bs-target="${modalTarget}"
                                    style="text-align: left;">
                                <i class="fa fa-plus-circle me-2"></i> Create New Client
                            </button>
                        </div>`;
                    $dropdown.append(addButtonHtml);
                }
            });
        }
        
        $(document).on("click", ".select2-add-btn-container button", function() { 
            $('select').select2('close'); 
        });

        function handleClientFormSubmit(selectSelector, modalSelector) {
            var $modal = $(modalSelector);
            var $form = $modal.find("form");
            
            $form.off("submit").on("submit", function (e) {
                e.preventDefault(); 
                var submitBtn = $form.find('[type="submit"]');
                var originalText = submitBtn.text();
                submitBtn.prop('disabled', true).text('Saving...');
                
                var formData = new FormData(this);
                $.ajax({
                    url: $form.attr('action'), 
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    success: function (response) {
                        if (response.success) {
                            var newOption = new Option(response.text, response.id, true, true);
                            $(selectSelector).append(newOption).trigger("change");
                            $modal.modal("hide");
                            $form[0].reset();
                        }
                    },
                    error: function (xhr) { 
                        alert("Error: " + (xhr.responseJSON?.errors || "Could not save client")); 
                    },
                    complete: function() { 
                        submitBtn.prop('disabled', false).text(originalText); 
                    }
                });
            });
        }

        // --- 7. INITIALIZE EXISTING FORM CONTROLS ---
        // Ensure all form controls have proper classes
        container.find('input:not([type=checkbox]):not([type=hidden]), select, textarea').addClass('form-control');
        
        // Fix initial form indices
        updateFormIndices();
        
        console.log('Form initialization completed');
    });
</script>
{% endblock javascript %}