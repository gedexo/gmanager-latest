{% extends 'app/base.html' %}
{% load static i18n crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}Edit Project{% else %}New Project{% endif %}
{% endblock %}

{% block content %}
<div class="side-app main-container edit_page pb-5">

    <!-- HEADER -->
    <div class="page-header d-flex justify-content-between align-items-end border-bottom mb-4 pb-3">
        <div>
            <h1 class="page-title fs-4 fw-bold mb-0 text-dark">
                {% if form.instance.pk %}Edit Project{% else %}New Project{% endif %}
            </h1>
            <small class="text-muted">Manage your project details, timeline, and tasks</small>
        </div>
        
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="javascript:void(0);" class="text-decoration-none text-muted">Projects</a></li>
                <li class="breadcrumb-item active" aria-current="page">Form</li>
            </ol>
        </nav>
    </div>

    <!-- FORM CONTAINER -->
    <div class="row justify-content-center">
        <div class="col-xl-12 col-lg-12">
            
            <form method="post" autocomplete="off" enctype="multipart/form-data" id="project-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger shadow-sm rounded-3 border-0 mb-4">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}

                {% if task_formset.non_form_errors %}
                    <div class="alert alert-danger shadow-sm rounded-3 border-0 mb-4">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        {{ task_formset.non_form_errors }}
                    </div>
                {% endif %}

                <div class="row g-4">
                    
                    <!-- LEFT COLUMN: MAIN CONTENT -->
                    <div class="col-lg-8">
                        <div class="card custom-card border-0 shadow-sm rounded-3 h-100">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">Core Information</h6>
                                
                                <div class="mb-4">
                                    {{ form.name|as_crispy_field }}
                                </div>
                                <div class="mb-4 compact-description">
                                    {{ form.details|as_crispy_field }}
                                </div>
                                
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: SIDEBAR META -->
                    <div class="col-lg-4">
                        <!-- PROPERTIES CARD -->
                        <div class="card custom-card border-0 shadow-sm rounded-3 mb-4">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">Properties</h6>
                                <div class="mb-3">
                                    {{ form.client|as_crispy_field }}
                                </div>
                                <div class="mb-3">
                                    {{ form.status|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <!-- TIMELINE CARD -->
                        <div class="card custom-card border-0 shadow-sm rounded-3">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">Schedule</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        {{ form.start_date|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.end_date|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-top border-light">
                                    {{ form.delivery_date|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <div class="card custom-card border-0 shadow-sm rounded-3">
                            <div class="card-body p-4">
                                <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-4">References</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        {{ form.department|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.subdepartment|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.discord_url|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.referred_by|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TASK INLINE FORMSET SECTION -->
                <div class="card custom-card border-0 shadow-sm rounded-3 mt-4">
                    <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                        <h6 class="text-uppercase fw-bold text-muted fs-11 ls-1 mb-0">Project Tasks</h6>
                        <button type="button" id="add-task-btn" class="btn btn-sm btn-light border text-primary fw-bold">
                            <i class="fa fa-plus me-1"></i> Add Task
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {{ task_formset.management_form }}
                        
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tasks-table">
                                <thead class="bg-light text-muted fs-11 text-uppercase">
                                    <tr>
                                        <th style="width: 20%;">Task Title</th>
                                        <th style="width: 15%;">Assign To</th>
                                        <th style="width: 12%;">Start Date</th>
                                        <th style="width: 12%;">End Date</th>
                                        <th style="width: 20%;">Description</th>
                                        <th style="width: 15%;">Attachment</th>
                                        <th style="width: 10%;">Status</th>
                                        <th style="width: 5%;" class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="task-form-container">
                                    {% for task_form in task_formset %}
                                        <tr class="task-row {% if task_form.instance.pk and task_form.DELETE.value %}d-none{% endif %}" id="task-row-{{ forloop.counter0 }}">
                                            {% for hidden in task_form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                            
                                            <!-- Hidden clear attachment field -->
                                            <input type="hidden" name="{{ task_form.clear_attachment.html_name }}" 
                                                   id="{{ task_form.clear_attachment.id_for_label }}" 
                                                   value="{% if task_form.clear_attachment.value %}True{% else %}False{% endif %}" 
                                                   class="clear-attachment-flag">
                                            
                                            <td class="p-2">
                                                {{ task_form.title }}
                                                {% if task_form.title.errors %}
                                                    <div class="text-danger small">{{ task_form.title.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.assigned_to }}
                                                {% if task_form.assigned_to.errors %}
                                                    <div class="text-danger small">{{ task_form.assigned_to.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.start_from }}
                                                {% if task_form.start_from.errors %}
                                                    <div class="text-danger small">{{ task_form.start_from.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.end_before }}
                                                {% if task_form.end_before.errors %}
                                                    <div class="text-danger small">{{ task_form.end_before.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.description }}
                                                {% if task_form.description.errors %}
                                                    <div class="text-danger small">{{ task_form.description.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2">
                                                <!-- Attachment field with custom styling -->
                                                <div class="attachment-container">
                                                    {{ task_form.attachment }}
                                                    {% if task_form.attachment.errors %}
                                                        <div class="text-danger small">{{ task_form.attachment.errors.0 }}</div>
                                                    {% endif %}
                                                    <div class="attachment-preview mt-2">
                                                        {% if task_form.instance.attachment %}
                                                            <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 existing-attachment">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="fa fa-paperclip me-2 text-muted"></i>
                                                                    <small class="text-truncate" style="max-width: 120px;">
                                                                        {{ task_form.instance.attachment.name }}
                                                                    </small>
                                                                </div>
                                                                <div class="d-flex gap-1">
                                                                    <a href="{{ task_form.instance.attachment.url }}" 
                                                                       target="_blank" 
                                                                       class="btn btn-sm btn-outline-primary btn-icon"
                                                                       title="View Attachment">
                                                                        <i class="fa fa-eye"></i>
                                                                    </a>
                                                                    <button type="button" 
                                                                            class="btn btn-sm btn-outline-danger btn-icon clear-existing-attachment"
                                                                            data-task-id="{{ task_form.instance.id }}"
                                                                            title="Clear Attachment">
                                                                        <i class="fa fa-times"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="p-2">
                                                {{ task_form.status }}
                                                {% if task_form.status.errors %}
                                                    <div class="text-danger small">{{ task_form.status.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="p-2 text-center">
                                                {% if task_formset.can_delete %}
                                                    <div class="d-none">{{ task_form.DELETE }}</div>
                                                    <button type="button" class="btn btn-sm btn-icon btn-light text-danger hover-danger remove-form-row">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM ACTIONS -->
                <div class="card custom-card border-0 shadow-sm rounded-3 mt-4">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted fs-13 ps-2">
                                <span class="text-danger">*</span> Required fields
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" onclick="history.back()" class="btn btn-light border text-muted px-4">
                                    {% translate "Cancel" %}
                                </button>
                                <button type="submit" class="btn btn-primary px-5 fw-bold">
                                    {% translate "Save Project" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- EMPTY ROW TEMPLATE -->
<script type="text/template" id="empty-row-template">
    <tr class="task-row">
        {% for hidden in task_formset.empty_form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        <!-- Hidden clear attachment field for new rows -->
        <input type="hidden" name="{{ task_formset.empty_form.clear_attachment.html_name }}" 
               value="False" 
               class="clear-attachment-flag">
        
        <td class="p-2">
            {{ task_formset.empty_form.title }}
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.assigned_to }}
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.start_from }}
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.end_before }}
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.description }}
        </td>
        <td class="p-2">
            <div class="attachment-container">
                {{ task_formset.empty_form.attachment }}
                <div class="attachment-preview mt-2"></div>
            </div>
        </td>
        <td class="p-2">
            {{ task_formset.empty_form.status }}
        </td>
        <td class="p-2 text-center">
            <div class="d-none">{{ task_formset.empty_form.DELETE }}</div>
            <button type="button" class="btn btn-sm btn-icon btn-light text-danger hover-danger remove-form-row">
                <i class="fa fa-trash"></i>
            </button>
        </td>
    </tr>
</script>

<!-- Modal -->
{% include 'clients/partials/client_form_modal.html' %}

{% endblock content %}

{% block javascript %}
{{ form.media }}
{{ task_formset.media }}

<style>
    /* Your existing CSS styles */
    .flatpickr-calendar {
        z-index: 1055 !important;
    }
    
    .table .form-control, .table .form-select {
        width: 100%;
        min-width: 80px; 
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
        border: 1px solid #dee2e6;
    }
    
    .table textarea {
        height: 36px;
        resize: none;
        transition: height 0.2s;
    }
    
    .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important; }
    .hover-danger:hover { color: #dc3545 !important; background: #fff1f2; }
    
    .attachment-container {
        position: relative;
    }
    
    .attachment-preview {
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    .table input[type="file"] {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        width: 100%;
    }
    
    .text-danger small {
        font-size: 0.75rem;
    }
    
    .datetime-input {
        min-height: 38px;
        font-size: 0.85rem;
    }
    
    .table select[name$="-status"] {
        min-width: 120px;
    }
    
    .btn-icon {
        width: 24px;
        height: 24px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }
    
    .attachment-preview .bg-light {
        border: 1px solid #e9ecef;
    }
    
    .existing-attachment.cleared {
        opacity: 0.5;
        background-color: #f8f9fa;
        text-decoration: line-through;
    }
</style>

<script>
    $(document).ready(function () {
        // --- 1. FORMSET LOGIC ---
        const formPrefix = 'project_tasks';
        const totalFormsInput = $(`#id_${formPrefix}-TOTAL_FORMS`);
        const container = $('#task-form-container');

        // ADD TASK BUTTON
        $('#add-task-btn').click(function() {
            const formCount = parseInt(totalFormsInput.val());
            
            // Get the template HTML from the script tag
            const templateHtml = $('#empty-row-template').html();
            
            // Replace __prefix__ with the current index
            const newRowHtml = templateHtml.replace(/__prefix__/g, formCount);
            const $newRow = $(newRowHtml);

            // Set a unique ID for the row
            $newRow.attr('id', `task-row-${formCount}`);
            
            // Apply styling to the new inputs
            $newRow.find('input:not([type=checkbox]), select, textarea').addClass('form-control');

            // Append to the TABLE BODY (tbody)
            container.append($newRow);

            // Update TOTAL_FORMS count
            totalFormsInput.val(formCount + 1);

            // Initialize Select2 on the new row
            initializeSelect2ForElement($newRow.find('select'));
            
            // Initialize file input handler for new row
            initializeFileInput($newRow.find('input[type="file"]'));
            
            // Fix status field initialization
            fixStatusField($newRow.find('select[name$="-status"]'));
            
            // Initialize clear attachment button for new row
            initializeClearAttachmentButton($newRow);
            
            // Initialize flatpickr for new date inputs
            initializeFlatpickr($newRow);
        });

        // DELETE TASK BUTTON
        container.on('click', '.remove-form-row', function() {
            const row = $(this).closest('tr');
            const deleteInput = row.find('input[name$="-DELETE"]');
            const idInput = row.find('input[name$="-id"]');

            if (idInput.length && idInput.val()) {
                // Existing Database Record: Check DELETE box and hide
                deleteInput.prop('checked', true);
                row.addClass('d-none');
            } else {
                // New Dynamic Row: Remove completely
                row.remove();
                updateFormIndices();
            }
        });

        // Helper: Update indices
        function updateFormIndices() {
            const currentRows = container.find('tr.task-row:not(.d-none)').length;
            totalFormsInput.val(currentRows);
        }

        // --- 2. ATTACHMENT HANDLING ---
        function initializeFileInput($fileInput) {
            $fileInput.on('change', function() {
                updateAttachmentPreview($(this));
            });
        }

        function updateAttachmentPreview($input) {
            const $row = $input.closest('tr');
            const $preview = $row.find('.attachment-preview');
            const file = $input[0].files[0];
            
            if (file) {
                const fileSize = formatFileSize(file.size);
                $preview.html(`
                    <div class="d-flex align-items-center justify-content-between bg-light rounded p-2">
                        <div class="d-flex align-items-center">
                            <i class="fa fa-paperclip me-2 text-muted"></i>
                            <div>
                                <small class="d-block text-truncate" style="max-width: 120px;">${file.name}</small>
                                <small class="text-muted">${fileSize}</small>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-icon view-attachment" 
                                    data-file-name="${file.name}" 
                                    data-file-url="${URL.createObjectURL(file)}"
                                    title="View Attachment">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-icon clear-attachment" 
                                    title="Clear Attachment">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                `);
                
                // Initialize the new clear button
                initializeClearAttachmentButton($row);
                // Initialize the new view button
                initializeViewAttachmentButton($row);
            } else {
                $preview.html('');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function initializeClearAttachmentButton($row) {
            // Clear button for newly selected files
            $row.find('.clear-attachment').off('click').on('click', function() {
                const $container = $(this).closest('.attachment-container');
                const $fileInput = $container.find('input[type="file"]');
                const $preview = $container.find('.attachment-preview');
                
                // Clear the file input
                $fileInput.val('');
                
                // Clear the preview
                $preview.html('');
            });

            // Clear button for existing attachments
            $row.find('.clear-existing-attachment').off('click').on('click', function() {
                const $container = $(this).closest('.attachment-container');
                const $previewContainer = $(this).closest('.existing-attachment');
                const $clearFlag = $row.find('.clear-attachment-flag');
                const $fileInput = $container.find('input[type="file"]');
                
                console.log('Clear attachment clicked for existing file');
                
                // Set the clear flag to True
                $clearFlag.val('True');
                
                // Also clear any file input value
                $fileInput.val('');
                
                // Visual indication that attachment will be removed
                $previewContainer.addClass('cleared');
                
                // Show simple message without checkbox
                $previewContainer.html(`
                    <div class="text-center text-muted">
                        <small><i class="fa fa-trash me-1"></i>Attachment cleared</small>
                    </div>
                `);
                
                console.log('Clear flag set to:', $clearFlag.val());
            });
        }

        function initializeViewAttachmentButton($row) {
            $row.find('.view-attachment').off('click').on('click', function() {
                const fileName = $(this).data('file-name');
                const fileUrl = $(this).data('file-url');
                
                // For newly selected files, we can open in a new tab
                if (fileUrl) {
                    window.open(fileUrl, '_blank');
                }
            });
        }

        // Initialize file inputs and attachment buttons for existing rows
        container.find('input[type="file"]').each(function() {
            initializeFileInput($(this));
        });
        
        container.find('.task-row').each(function() {
            initializeClearAttachmentButton($(this));
            initializeViewAttachmentButton($(this));
        });

        // --- 3. OTHER INITIALIZATIONS ---
        function fixStatusField($statusSelect) {
            if ($statusSelect.find('option').length === 0) {
                const statusOptions = [
                    {value: 'not_started', text: 'Not Started'},
                    {value: 'in_progress', text: 'In Progress'},
                    {value: 'completed', text: 'Completed'},
                    {value: 'on_hold', text: 'On Hold'}
                ];
                
                statusOptions.forEach(option => {
                    $statusSelect.append(new Option(option.text, option.value));
                });
            }
            
            if (!$statusSelect.val()) {
                $statusSelect.val('not_started');
            }
        }

        function initializeFlatpickr($row) {
            $row.find('.flatpicker').flatpickr({
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true
            });
        }

        function initializeSelect2ForElement($el) {
            $el.select2({
                width: '100%',
                placeholder: 'Select...',
                allowClear: true,
                dropdownParent: $el.closest('.modal').length ? $el.closest('.modal') : $(document.body)
            });
        }

        // Initialize existing elements
        container.find('select[name$="-status"]').each(function() {
            fixStatusField($(this));
        });

        container.find('.flatpicker').each(function() {
            initializeFlatpickr($(this).closest('tr'));
        });

        container.find('select').each(function() {
            initializeSelect2ForElement($(this));
        });

        // --- 4. FORM SUBMISSION ---
        $('#project-form').on('submit', function(e) {
            console.log('Form submission started...');
            
            // Debug: Log all clear attachment flags
            $('.clear-attachment-flag').each(function() {
                console.log('Clear attachment flag:', $(this).attr('name'), 'value:', $(this).val());
            });
            
            // Your existing validation code...
            const visibleRows = container.find('tr.task-row:not(.d-none)').length;
            totalFormsInput.val(visibleRows);
        });

        // --- 5. MODAL LOGIC (keep your existing modal code) ---
        // ... your existing modal functions ...

        // --- 6. INITIALIZE EXISTING FORM CONTROLS ---
        container.find('input:not([type=checkbox]):not([type=hidden]), select, textarea').addClass('form-control');
        updateFormIndices();
        
        console.log('Form initialization completed');
    });
</script>
{% endblock javascript %}